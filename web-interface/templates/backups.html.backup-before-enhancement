{% extends "base.html" %}

{% block title %}Full System Backups - System Restore Toolkit{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-archive"></i> Full System Backups</h1>
                <div>
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#createBackupModal">
                        <i class="fas fa-plus"></i> Create Backup
                    </button>
                    <button class="btn btn-outline-primary ms-2" onclick="refreshBackups()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <p class="lead">Complete system backups for disaster recovery</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Available Backups</h5>
                </div>
                <div class="card-body">
                    {% if backups_info.success %}
                        {% if "full-backup-" in backups_info.output %}
                            <div class="backup-list bg-light p-3 rounded">
                                <pre class="mb-3">{{ backups_info.output }}</pre>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-tools"></i> Backup Actions:</h6>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-danger" onclick="showDeleteBackupModal()">
                                                <i class="fas fa-trash"></i> Delete Backup
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning" onclick="showRestoreInstructions()">
                                                <i class="fas fa-undo"></i> Restore Instructions
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" onclick="showBackupDetails()">
                                                <i class="fas fa-info-circle"></i> Backup Details
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-terminal"></i> Quick Commands:</h6>
                                        <div class="d-flex flex-wrap gap-2">
                                            <code class="user-select-all">./system-restore-toolkit list-backups</code>
                                            <code class="user-select-all">./system-restore-toolkit remove-backup filename.tar.gz</code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> No backups found. Create your first backup above.
                                <pre class="mt-2 mb-0">{{ backups_info.output }}</pre>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-danger">
                            <strong>Error loading backups:</strong> {{ backups_info.error }}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="fas fa-info-circle"></i> Backup Information</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success"></i> <strong>Complete System Archives:</strong> Full system state preservation</li>
                        <li><i class="fas fa-check text-success"></i> <strong>Disaster Recovery:</strong> Restore entire system from scratch</li>
                        <li><i class="fas fa-check text-success"></i> <strong>Portable Format:</strong> Standard tar.gz archives</li>
                        <li><i class="fas fa-check text-success"></i> <strong>Long-term Storage:</strong> Keep for extended periods</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-exclamation-triangle"></i> Important Notes</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><i class="fas fa-clock text-warning"></i> <strong>Time:</strong> Creation takes 30+ minutes</li>
                        <li><i class="fas fa-hdd text-warning"></i> <strong>Size:</strong> Backups can be 50+ GB</li>
                        <li><i class="fas fa-space-shuttle text-warning"></i> <strong>Space:</strong> Ensure adequate disk space</li>
                        <li><i class="fas fa-test text-warning"></i> <strong>Testing:</strong> Verify backups regularly</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-terminal"></i> Backup Commands Reference</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Management Commands:</h6>
                            <pre class="bg-light p-3">
# List all backups
./system-restore-toolkit list-backups

# Create new backup
./system-restore-toolkit create-backup "Description"

# Remove specific backup
./system-restore-toolkit remove-backup filename.tar.gz</pre>
                        </div>
                        <div class="col-md-6">
                            <h6>Manual Restoration Examples:</h6>
                            <pre class="bg-light p-3">
# Extract to root (DANGEROUS!)
sudo tar -xzf backup.tar.gz -C /

# Extract specific directories
sudo tar -xzf backup.tar.gz -C / home/
sudo tar -xzf backup.tar.gz -C / etc/

# List backup contents
tar -tzf backup.tar.gz | head -20</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Backup Modal -->
<div class="modal fade" id="createBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('create_backup') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Create Full System Backup</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="description" class="form-label">Backup Description</label>
                        <input type="text" class="form-control" id="description" name="description" placeholder="e.g., Before system upgrade">
                    </div>
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-clock"></i> Backup Process:</h6>
                        <ul class="mb-0">
                            <li>Process runs in background (30-60 minutes)</li>
                            <li>System remains fully usable</li>
                            <li>Large file size (check disk space first)</li>
                            <li>Monitor logs for completion status</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-play"></i> Start Backup
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Backup Modal -->
<div class="modal fade" id="deleteBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This will permanently delete the backup file!
                </div>
                <p>To delete a backup, use the command line:</p>
                <pre class="bg-light p-2">./system-restore-toolkit remove-backup filename.tar.gz</pre>
                <p class="mb-0">Replace "filename.tar.gz" with the actual backup filename shown above.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Restore Instructions Modal -->
<div class="modal fade" id="restoreInstructionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-undo"></i> Backup Restoration Instructions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <h5><i class="fas fa-skull-crossbones"></i> EXTREME CAUTION REQUIRED</h5>
                    <p><strong>Improper restoration can completely destroy your system!</strong></p>
                </div>
                
                <h6>Safe Restoration Process:</h6>
                <ol>
                    <li><strong>Boot from Live USB/CD</strong> - Never restore on running system</li>
                    <li><strong>Mount target drive</strong> - Identify correct drive first</li>
                    <li><strong>Extract backup carefully</strong> - Use proper tar commands</li>
                    <li><strong>Update bootloader</strong> - Fix GRUB if needed</li>
                    <li><strong>Test thoroughly</strong> - Verify system before production use</li>
                </ol>
                
                <h6>Example Commands (Run in Recovery Environment):</h6>
                <pre class="bg-dark text-light p-3">
# Mount your target drive (replace /dev/sdX1 with your drive)
sudo mount /dev/sdX1 /mnt

# Extract backup to mounted drive
sudo tar -xzf full-backup-YYYYMMDD_HHMMSS.tar.gz -C /mnt

# Update GRUB bootloader (if needed)
sudo chroot /mnt update-grub

# Unmount and reboot
sudo umount /mnt
sudo reboot</pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function refreshBackups() {
    location.reload();
}

function showDeleteBackupModal() {
    const modal = new bootstrap.Modal(document.getElementById('deleteBackupModal'));
    modal.show();
}

function showRestoreInstructions() {
    const modal = new bootstrap.Modal(document.getElementById('restoreInstructionsModal'));
    modal.show();
}

function showBackupDetails() {
    alert("Backup Details:\n\n• Format: tar.gz archive\n• Contents: Full system state\n• Location: backups/ directory\n• Use: ./system-restore-toolkit list-backups for details");
}
</script>
{% endblock %}
