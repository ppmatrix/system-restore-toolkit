{% extends "base.html" %}

{% block title %}Dashboard - System Restore Toolkit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-tachometer-alt"></i> System Dashboard</h1>
        <p class="lead">Monitor your system's backup and restore status</p>
    </div>
</div>

<!-- System Statistics Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-chart-line"></i> System Statistics</h5>
            </div>
            <div class="card-body">
                {% if system_stats and system_stats.success %}
                    <div class="row">
                        <!-- System Information -->
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <div class="text-primary mb-2">
                                        <i class="fas fa-server fa-2x"></i>
                                    </div>
                                    <h6 class="card-title">System Info</h6>
                                    <div class="stats-info">
                                        <div><strong>Host:</strong> {{ system_stats.stats.hostname }}</div>
                                        <div><strong>OS:</strong> {{ system_stats.stats.os }}</div>
                                        <div><strong>Kernel:</strong> {{ system_stats.stats.kernel }}</div>
                                        <div><strong>Uptime:</strong> {{ system_stats.stats.uptime }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CPU Information -->
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <div class="text-success mb-2">
                                        <i class="fas fa-microchip fa-2x"></i>
                                    </div>
                                    <h6 class="card-title">Processor</h6>
                                    <div class="stats-info">
                                        <div class="text-truncate" title="{{ system_stats.stats.cpu }}">
                                            <strong>CPU:</strong> {{ system_stats.stats.cpu }}
                                        </div>
                                        <div><strong>Load:</strong> {{ system_stats.stats.load_average }}</div>
                                        {% if system_stats.stats.temperature != 'Not available' %}
                                        <div class="text-truncate" title="{{ system_stats.stats.temperature }}">
                                            <strong>Temp:</strong> {{ system_stats.stats.temperature }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Memory Information -->
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <div class="text-info mb-2">
                                        <i class="fas fa-memory fa-2x"></i>
                                    </div>
                                    <h6 class="card-title">Memory</h6>
                                    <div class="stats-info">
                                        <div><strong>RAM:</strong> {{ system_stats.stats.memory }}</div>
                                        <!-- Memory usage bar with accurate percentage -->
                                        {% if system_stats.stats.memory != 'Unknown' and system_stats.stats.memory_percent %}
                                        <div class="progress mt-2" style="height: 6px;">
                                            {% set mem_percent = system_stats.stats.memory_percent %}
                                            <div class="progress-bar {% if mem_percent > 85 %}bg-danger{% elif mem_percent > 70 %}bg-warning{% else %}bg-info{% endif %}" 
                                                 role="progressbar" style="width: {{ mem_percent }}%" 
                                                 aria-valuenow="{{ mem_percent }}" aria-valuemin="0" aria-valuemax="100"
                                                 title="{{ mem_percent }}% memory used"></div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- GPU Information -->
                        {% if system_stats.stats.gpu_detailed and system_stats.stats.gpus %}
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <div class="text-warning mb-2">
                                        <i class="fas fa-tv fa-2x"></i>
                                    </div>
                                    <h6 class="card-title">NVIDIA Graphics</h6>
                                    
                                    {% for gpu in system_stats.stats.gpus %}
                                    <div class="gpu-compact mb-2 {% if not loop.last %}border-bottom pb-2{% endif %}">
                                        <div class="gpu-name-compact">
                                            <strong class="d-block text-truncate" style="font-size: 0.85em;" title="{{ gpu.name }}">
                                                GPU {{ loop.index }}: {{ gpu.name.split(' ')[-2:] | join(' ') }}
                                            </strong>
                                        </div>
                                        
                                        <div class="row mt-1 gpu-metrics-compact">
                                            <div class="col-6">
                                                <div class="metric-compact">
                                                    <span class="metric-label">Mem:</span>
                                                    <span class="metric-value text-primary">{{ (gpu.memory_used/1024)|round(1) }}GB</span>
                                                    <div class="progress-compact">
                                                        {% set mem_percent = ((gpu.memory_used / gpu.memory_total) * 100) | round(0) %}
                                                        <div class="progress-bar-compact {% if mem_percent > 80 %}bg-danger{% elif mem_percent > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                                             style="width: {{ mem_percent }}%" title="{{ mem_percent }}%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-6">
                                                <div class="metric-compact">
                                                    <span class="metric-label">Util:</span>
                                                    <span class="metric-value text-success">{{ gpu.utilization_gpu }}%</span>
                                                    <div class="progress-compact">
                                                        <div class="progress-bar-compact {% if gpu.utilization_gpu > 80 %}bg-danger{% elif gpu.utilization_gpu > 50 %}bg-warning{% else %}bg-success{% endif %}" 
                                                             style="width: {{ gpu.utilization_gpu }}%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-1 gpu-metrics-compact">
                                            <div class="col-6">
                                                <div class="metric-compact">
                                                    <span class="metric-label">Temp:</span>
                                                    <span class="metric-value text-info">{{ gpu.temperature }}Â°C</span>
                                                    <div class="progress-compact">
                                                        <div class="progress-bar-compact {% if gpu.temperature > 80 %}bg-danger{% elif gpu.temperature > 65 %}bg-warning{% else %}bg-success{% endif %}" 
                                                             style="width: {{ (gpu.temperature / 90 * 100) | round(0) }}%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-6">
                                                <div class="metric-compact">
                                                    <span class="metric-label">Power:</span>
                                                    <span class="metric-value text-danger">{{ gpu.power_draw|round(0) }}W</span>
                                                    <div class="progress-compact">
                                                        {% set power_percent = ((gpu.power_draw / gpu.power_limit) * 100) | round(0) %}
                                                        <div class="progress-bar-compact {% if power_percent > 80 %}bg-danger{% elif power_percent > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                                             style="width: {{ power_percent }}%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <div class="text-warning mb-2">
                                        <i class="fas fa-tv fa-2x"></i>
                                    </div>
                                    <h6 class="card-title">Graphics</h6>
                                    <div class="stats-info">
                                        <div class="text-truncate" title="{{ system_stats.stats.gpu }}">
                                            <strong>GPU:</strong> {{ system_stats.stats.gpu }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Disk Usage -->
                        <div class="col-lg-8 col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                    <div class="text-center">
                                        <div class="text-danger mb-2">
                                            <i class="fas fa-hdd fa-2x"></i>
                                        </div>
                                        <h6 class="card-title">Disk Usage</h6>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <div class="stats-metric">
                                                <div class="stats-value text-primary">{{ system_stats.stats.disk_total }}</div>
                                                <div class="stats-label">Total</div>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="stats-metric">
                                                <div class="stats-value text-danger">{{ system_stats.stats.disk_used }}</div>
                                                <div class="stats-label">Used</div>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="stats-metric">
                                                <div class="stats-value text-success">{{ system_stats.stats.disk_available }}</div>
                                                <div class="stats-label">Available</div>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="stats-metric">
                                                <div class="stats-value text-warning">{{ system_stats.stats.disk_percent }}</div>
                                                <div class="stats-label">Usage</div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Disk usage progress bar -->
                                    {% if system_stats.stats.disk_percent != 'Unknown' %}
                                    <div class="progress mt-3" style="height: 10px;">
                                        {% set usage_percent = system_stats.stats.disk_percent.rstrip('%') | int %}
                                        <div class="progress-bar {% if usage_percent > 90 %}bg-danger{% elif usage_percent > 70 %}bg-warning{% else %}bg-success{% endif %}" 
                                             role="progressbar" style="width: {{ usage_percent }}%" 
                                             aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ system_stats.stats.disk_percent }}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Error loading system statistics:</strong> {{ system_stats.error if system_stats.error else 'Unknown error' }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions and Backups Row -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#createBackupModal">
                        <i class="fas fa-archive"></i> Create System Backup
                    </button>
                    <a href="{{ url_for('timeshift') }}" class="btn btn-info">
                        <i class="fas fa-clock"></i> Manage Timeshift
                    </a>
                    <a href="{{ url_for('logs') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-file-alt"></i> View System Logs
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-archive"></i> Recent Backups</h5>
            </div>
            <div class="card-body">
                {% if backups_info.success %}
                    {% if "full-backup-" in backups_info.output %}
                        <div class="backup-preview">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <strong>Latest Backup Available</strong>
                            </div>
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('backups') }}" class="btn btn-outline-primary">
                                    <i class="fas fa-list"></i> Manage All Backups
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>No backups found.</strong> Create your first backup to get started.
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#createBackupModal">
                                <i class="fas fa-plus"></i> Create First Backup
                            </button>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Unable to load backup status.</strong>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Create Backup Modal -->
<div class="modal fade" id="createBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Create New Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_backup') }}">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        This will create a complete system backup. The process may take several minutes depending on your system size.
                    </div>
                    <div class="mb-3">
                        <label for="backupDescription" class="form-label">Description (Optional)</label>
                        <input type="text" class="form-control" name="description" id="backupDescription" 
                               placeholder="e.g., Before system update">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-play"></i> Start Backup
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.stats-info {
    font-size: 0.9em;
    line-height: 1.4;
}

.stats-info > div {
    margin-bottom: 4px;
}

.stats-metric {
    padding: 8px;
}

.stats-value {
    font-size: 1.2em;
    font-weight: bold;
}

.stats-label {
    font-size: 0.8em;
    color: #6c757d;
    text-transform: uppercase;
}

.card.h-100 {
    transition: transform 0.2s;
}

.card.h-100:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}


/* Compact GPU Styles */
.gpu-compact {
    font-size: 0.9em;
    padding: 8px 0;
}

.gpu-name-compact {
    margin-bottom: 6px;
}

.gpu-metrics-compact {
    margin-bottom: 4px;
}

.metric-compact {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2px;
}

.metric-label {
    font-size: 0.7em;
    color: #6c757d;
    text-transform: uppercase;
    font-weight: 600;
    line-height: 1;
}

.metric-value {
    font-size: 0.85em;
    font-weight: bold;
    line-height: 1.2;
    margin: 1px 0;
}

.progress-compact {
    width: 100%;
    height: 3px;
    background-color: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
    margin-top: 2px;
}

.progress-bar-compact {
    height: 100%;
    transition: width 0.3s ease;
}

.progress-bar-compact.bg-success {
    background-color: #28a745;
}

.progress-bar-compact.bg-warning {
    background-color: #ffc107;
}

.progress-bar-compact.bg-danger {
    background-color: #dc3545;
}

@media (max-width: 768px) {
    .gpu-metrics-compact .col-6 {
        margin-bottom: 6px;
    }
    
    .metric-compact {
        padding: 4px;
    }
}

.gpu-details {
    margin-bottom: 1rem;
}

.gpu-metrics .stats-metric {
    padding: 4px;
}

.gpu-metrics .stats-value {
    font-size: 1.1em;
    font-weight: bold;
    line-height: 1.2;
}

.gpu-metrics .stats-label {
    font-size: 0.75em;
    color: #6c757d;
    text-transform: uppercase;
    margin-bottom: 2px;
}

.gpu-metrics .progress {
}

.card.bg-light:hover {
}

@media (max-width: 768px) {
    .gpu-metrics .col-3 {
        margin-bottom: 10px;
    }
}

/* Dark Mode Statistics Enhancements */
[data-theme="dark"] .stats-info {
    color: var(--text-color);
}

[data-theme="dark"] .stats-value {
    color: inherit;
}

[data-theme="dark"] .stats-label {
    color: var(--muted-text);
}

[data-theme="dark"] .metric-label {
    color: var(--muted-text);
}

[data-theme="dark"] .metric-value {
    color: inherit;
}

[data-theme="dark"] .progress {
    background-color: rgba(255, 255, 255, 0.1);
}

[data-theme="dark"] .progress-compact {
    background-color: rgba(255, 255, 255, 0.1);
}

[data-theme="dark"] .border-bottom {
}

/* Ensure progress bars maintain their colors in dark mode */
[data-theme="dark"] .progress-bar.bg-success,
[data-theme="dark"] .progress-bar-compact.bg-success {
}

[data-theme="dark"] .progress-bar.bg-warning,
[data-theme="dark"] .progress-bar-compact.bg-warning {
}

[data-theme="dark"] .progress-bar.bg-danger,
[data-theme="dark"] .progress-bar-compact.bg-danger {
}

[data-theme="dark"] .progress-bar.bg-info {
}

[data-theme="dark"] .progress-bar.bg-primary {
}

/* Badge colors in dark mode */
[data-theme="dark"] .badge.bg-primary {
}

[data-theme="dark"] .badge.bg-secondary {
}

[data-theme="dark"] .badge.bg-warning {
}

[data-theme="dark"] .badge.bg-success {
}

[data-theme="dark"] .badge.bg-info {
}

[data-theme="dark"] .badge.bg-danger {
}
</style>
{% endblock %}
