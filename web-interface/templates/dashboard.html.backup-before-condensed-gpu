{% extends "base.html" %}

{% block title %}Dashboard - System Restore Toolkit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-tachometer-alt"></i> System Dashboard</h1>
        <p class="lead">Monitor your system's backup and restore status</p>
    </div>
</div>

<!-- System Statistics Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-chart-line"></i> System Statistics</h5>
            </div>
            <div class="card-body">
                {% if system_stats and system_stats.success %}
                    <div class="row">
                        <!-- System Information -->
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <div class="text-primary mb-2">
                                        <i class="fas fa-server fa-2x"></i>
                                    </div>
                                    <h6 class="card-title">System Info</h6>
                                    <div class="stats-info">
                                        <div><strong>Host:</strong> {{ system_stats.stats.hostname }}</div>
                                        <div><strong>OS:</strong> {{ system_stats.stats.os }}</div>
                                        <div><strong>Kernel:</strong> {{ system_stats.stats.kernel }}</div>
                                        <div><strong>Uptime:</strong> {{ system_stats.stats.uptime }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CPU Information -->
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <div class="text-success mb-2">
                                        <i class="fas fa-microchip fa-2x"></i>
                                    </div>
                                    <h6 class="card-title">Processor</h6>
                                    <div class="stats-info">
                                        <div class="text-truncate" title="{{ system_stats.stats.cpu }}">
                                            <strong>CPU:</strong> {{ system_stats.stats.cpu }}
                                        </div>
                                        <div><strong>Load:</strong> {{ system_stats.stats.load_average }}</div>
                                        {% if system_stats.stats.temperature != 'Not available' %}
                                        <div class="text-truncate" title="{{ system_stats.stats.temperature }}">
                                            <strong>Temp:</strong> {{ system_stats.stats.temperature }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Memory Information -->
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <div class="text-info mb-2">
                                        <i class="fas fa-memory fa-2x"></i>
                                    </div>
                                    <h6 class="card-title">Memory</h6>
                                    <div class="stats-info">
                                        <div><strong>RAM:</strong> {{ system_stats.stats.memory }}</div>
                                        <!-- Memory usage bar if we can parse the values -->
                                        {% if system_stats.stats.memory != 'Unknown' %}
                                        <div class="progress mt-2" style="height: 6px;">
                                            <div class="progress-bar bg-info" role="progressbar" style="width: 60%" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- GPU Information -->
                        {% if system_stats.stats.gpu_detailed and system_stats.stats.gpus %}
                        <div class="col-lg-8 col-md-12 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                    <div class="text-center">
                                        <div class="text-warning mb-2">
                                            <i class="fas fa-tv fa-2x"></i>
                                        </div>
                                        <h6 class="card-title">NVIDIA Graphics</h6>
                                    </div>
                                    {% for gpu in system_stats.stats.gpus %}
                                    <div class="gpu-details mb-3 {% if not loop.last %}border-bottom pb-3{% endif %}">
                                        <div class="row text-center">
                                            <div class="col-12 mb-2">
                                                <strong class="text-truncate d-block" title="{{ gpu.name }}">{{ gpu.name }}</strong>
                                                <span class="badge bg-secondary">GPU {{ loop.index }}</span>
                                            </div>
                                        </div>
                                        
                                        <div class="row text-center gpu-metrics">
                                            <div class="col-3">
                                                <div class="stats-metric">
                                                    <div class="stats-value text-primary">{{ (gpu.memory_used/1024)|round(1) }}GB</div>
                                                    <div class="stats-label">Memory</div>
                                                    <div class="progress mt-1" style="height: 4px;">
                                                        {% set mem_percent = ((gpu.memory_used / gpu.memory_total) * 100) | round(0) %}
                                                        <div class="progress-bar {% if mem_percent > 80 %}bg-danger{% elif mem_percent > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                                             style="width: {{ mem_percent }}%" title="{{ mem_percent }}% ({{ (gpu.memory_used/1024)|round(1) }}GB / {{ (gpu.memory_total/1024)|round(1) }}GB)"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-3">
                                                <div class="stats-metric">
                                                    <div class="stats-value text-success">{{ gpu.utilization_gpu }}%</div>
                                                    <div class="stats-label">Utilization</div>
                                                    <div class="progress mt-1" style="height: 4px;">
                                                        <div class="progress-bar {% if gpu.utilization_gpu > 80 %}bg-danger{% elif gpu.utilization_gpu > 50 %}bg-warning{% else %}bg-success{% endif %}" 
                                                             style="width: {{ gpu.utilization_gpu }}%" title="{{ gpu.utilization_gpu }}%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-3">
                                                <div class="stats-metric">
                                                    <div class="stats-value text-info">{{ gpu.temperature }}°C</div>
                                                    <div class="stats-label">Temperature</div>
                                                    <div class="progress mt-1" style="height: 4px;">
                                                        {% set temp_percent = (gpu.temperature / 90 * 100) | round(0) %}
                                                        <div class="progress-bar {% if gpu.temperature > 80 %}bg-danger{% elif gpu.temperature > 65 %}bg-warning{% else %}bg-success{% endif %}" 
                                                             style="width: {{ temp_percent }}%" title="{{ gpu.temperature }}°C"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-3">
                                                <div class="stats-metric">
                                                    <div class="stats-value text-danger">{{ gpu.power_draw|round(0) }}W</div>
                                                    <div class="stats-label">Power</div>
                                                    <div class="progress mt-1" style="height: 4px;">
                                                        {% set power_percent = ((gpu.power_draw / gpu.power_limit) * 100) | round(0) %}
                                                        <div class="progress-bar {% if power_percent > 80 %}bg-danger{% elif power_percent > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                                             style="width: {{ power_percent }}%" title="{{ gpu.power_draw|round(1) }}W / {{ gpu.power_limit|round(0) }}W"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <div class="text-warning mb-2">
                                        <i class="fas fa-tv fa-2x"></i>
                                    </div>
                                    <h6 class="card-title">Graphics</h6>
                                    <div class="stats-info">
                                        <div class="text-truncate" title="{{ system_stats.stats.gpu }}">
                                            <strong>GPU:</strong> {{ system_stats.stats.gpu }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Disk Usage -->
                        <div class="col-lg-8 col-md-6 mb-3">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                    <div class="text-center">
                                        <div class="text-danger mb-2">
                                            <i class="fas fa-hdd fa-2x"></i>
                                        </div>
                                        <h6 class="card-title">Disk Usage</h6>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <div class="stats-metric">
                                                <div class="stats-value text-primary">{{ system_stats.stats.disk_total }}</div>
                                                <div class="stats-label">Total</div>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="stats-metric">
                                                <div class="stats-value text-danger">{{ system_stats.stats.disk_used }}</div>
                                                <div class="stats-label">Used</div>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="stats-metric">
                                                <div class="stats-value text-success">{{ system_stats.stats.disk_available }}</div>
                                                <div class="stats-label">Available</div>
                                            </div>
                                        </div>
                                        <div class="col-3">
                                            <div class="stats-metric">
                                                <div class="stats-value text-warning">{{ system_stats.stats.disk_percent }}</div>
                                                <div class="stats-label">Usage</div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Disk usage progress bar -->
                                    {% if system_stats.stats.disk_percent != 'Unknown' %}
                                    <div class="progress mt-3" style="height: 10px;">
                                        {% set usage_percent = system_stats.stats.disk_percent.rstrip('%') | int %}
                                        <div class="progress-bar {% if usage_percent > 90 %}bg-danger{% elif usage_percent > 70 %}bg-warning{% else %}bg-success{% endif %}" 
                                             role="progressbar" style="width: {{ usage_percent }}%" 
                                             aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ system_stats.stats.disk_percent }}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Error loading system statistics:</strong> {{ system_stats.error if system_stats.error else 'Unknown error' }}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions and Backups Row -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#createBackupModal">
                        <i class="fas fa-archive"></i> Create System Backup
                    </button>
                    <a href="{{ url_for('timeshift') }}" class="btn btn-info">
                        <i class="fas fa-clock"></i> Manage Timeshift
                    </a>
                    <a href="{{ url_for('logs') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-file-alt"></i> View System Logs
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-archive"></i> Recent Backups</h5>
            </div>
            <div class="card-body">
                {% if backups_info.success %}
                    {% if "full-backup-" in backups_info.output %}
                        <div class="backup-preview">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <strong>Latest Backup Available</strong>
                            </div>
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('backups') }}" class="btn btn-outline-primary">
                                    <i class="fas fa-list"></i> Manage All Backups
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>No backups found.</strong> Create your first backup to get started.
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#createBackupModal">
                                <i class="fas fa-plus"></i> Create First Backup
                            </button>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Unable to load backup status.</strong>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Create Backup Modal -->
<div class="modal fade" id="createBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Create New Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_backup') }}">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        This will create a complete system backup. The process may take several minutes depending on your system size.
                    </div>
                    <div class="mb-3">
                        <label for="backupDescription" class="form-label">Description (Optional)</label>
                        <input type="text" class="form-control" name="description" id="backupDescription" 
                               placeholder="e.g., Before system update">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-play"></i> Start Backup
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.stats-info {
    font-size: 0.9em;
    line-height: 1.4;
}

.stats-info > div {
    margin-bottom: 4px;
}

.stats-metric {
    padding: 8px;
}

.stats-value {
    font-size: 1.2em;
    font-weight: bold;
}

.stats-label {
    font-size: 0.8em;
    color: #6c757d;
    text-transform: uppercase;
}

.card.h-100 {
    transition: transform 0.2s;
}

.card.h-100:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.gpu-details {
    margin-bottom: 1rem;
}

.gpu-metrics .stats-metric {
    padding: 4px;
}

.gpu-metrics .stats-value {
    font-size: 1.1em;
    font-weight: bold;
    line-height: 1.2;
}

.gpu-metrics .stats-label {
    font-size: 0.75em;
    color: #6c757d;
    text-transform: uppercase;
    margin-bottom: 2px;
}

.gpu-metrics .progress {
}

.card.bg-light:hover {
}

@media (max-width: 768px) {
    .gpu-metrics .col-3 {
        margin-bottom: 10px;
    }
}
</style>
{% endblock %}
