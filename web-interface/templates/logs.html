{% extends "base.html" %}

{% block title %}System Logs - System Restore Toolkit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-file-alt"></i> System Logs</h1>
        <p class="lead">View and monitor all system restore toolkit logs from multiple sources</p>
        <div class="alert alert-info">
            <h6><i class="fas fa-info-circle"></i> Enhanced Logging</h6>
            <div class="row">
                <div class="col-md-4">
                    <strong><i class="fas fa-cogs text-primary"></i> Toolkit Logs:</strong><br>
                    <small>Main operations and command execution</small>
                </div>
                <div class="col-md-4">
                    <strong><i class="fas fa-globe text-info"></i> Web Interface:</strong><br>
                    <small>Web server operations and errors</small>
                </div>
                <div class="col-md-4">
                    <strong><i class="fas fa-server text-warning"></i> System Logs:</strong><br>
                    <small>Timeshift, backups, and system events</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Available Log Files</h5>
            </div>
            <div class="card-body">
                {% if log_files %}
                    <div class="list-group">
                        {% for log in log_files %}
                        <a href="#" class="list-group-item list-group-item-action" onclick="loadLogFile('{{ log.name }}')"
                           data-log-type="{{ log.type }}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">
                                    {% if log.type == "Toolkit" %}
                                        <i class="fas fa-cogs text-primary"></i>
                                    {% elif log.type == "Web Interface" %}
                                        <i class="fas fa-globe text-info"></i>
                                    {% elif log.type == "System" %}
                                        <i class="fas fa-server text-warning"></i>
                                    {% endif %}
                                    {{ log.name }}
                                </h6>
                                <small>
                                    {% if log.size != "Variable" %}
                                        {{ log.size | filesizeformat if log.size else "0 bytes" }}
                                    {% else %}
                                        <i class="fas fa-sync-alt"></i> Dynamic
                                    {% endif %}
                                </small>
                            </div>
                            <div class="d-flex w-100 justify-content-between">
                                <small class="text-muted">{{ log.description }}</small>
                                <span class="badge badge-sm 
                                    {% if log.type == "Toolkit" %}bg-primary
                                    {% elif log.type == "Web Interface" %}bg-info
                                    {% elif log.type == "System" %}bg-warning text-dark
                                    {% endif %}">{{ log.type }}</span>
                            </div>
                            {% if log.size != "Variable" %}
                            <small class="text-muted">Modified: {{ log.modified.strftime('%Y-%m-%d %H:%M') if log.modified else 'Unknown' }}</small>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No log files found in the logs directory.
                    </div>
                {% endif %}
                
                <div class="mt-3">
                    <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i> Manual Refresh
                    <button class="btn btn-sm btn-outline-info" onclick="scrollToBottom()" id="scroll-bottom-btn" style="display: none;" title="Scroll to bottom">
                        <i class="fas fa-arrow-down"></i> Bottom
                    </button>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 id="log-title"><i class="fas fa-file-alt"></i> Log Content</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshLogContent()" id="refresh-btn" style="display: none;">
                        <i class="fas fa-sync-alt"></i> Manual Refresh
                    <button class="btn btn-sm btn-outline-info" onclick="scrollToBottom()" id="scroll-bottom-btn" style="display: none;" title="Scroll to bottom">
                        <i class="fas fa-arrow-down"></i> Bottom
                    </button>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="downloadLog()" id="download-btn" style="display: none;">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="log-content">
                    <div class="text-center text-muted">
                        <i class="fas fa-file-alt fa-3x mb-3"></i>
                        <p>Select a log file from the left panel to view its contents.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-info-circle"></i> Log Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-list"></i> Log Types:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-circle text-primary"></i> <strong>toolkit-*.log:</strong> Main application logs</li>
                            <li><i class="fas fa-circle text-success"></i> <strong>snapshots.log:</strong> LVM snapshot operations</li>
                            <li><i class="fas fa-circle text-warning"></i> <strong>backups.log:</strong> Full system backup operations</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-search"></i> Log Levels:</h6>
                        <ul class="list-unstyled">
                            <li><span class="badge bg-info">INFO</span> Informational messages</li>
                            <li><span class="badge bg-success">SUCCESS</span> Successful operations</li>
                            <li><span class="badge bg-warning">WARNING</span> Warning messages</li>
                            <li><span class="badge bg-danger">ERROR</span> Error conditions</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentLogFile = null;

function loadLogFile(filename) {
    currentLogFile = filename;
    document.getElementById("log-title").innerHTML = `<i class="fas fa-file-alt"></i> ${filename}`;
    document.getElementById("refresh-btn").style.display = "inline-block";
    document.getElementById("download-btn").style.display = "inline-block";
    document.getElementById("scroll-bottom-btn").style.display = "inline-block";
    
    // Show loading
    document.getElementById("log-content").innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading log file...</p>
        </div>
    `;
    
    // Fetch actual log content from API
    fetch(`/api/logs/${filename}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const logTypeInfo = data.type ? `<small class="text-muted">Type: ${data.type} | </small>` : "";
                const lineInfo = data.lines ? `Lines: ${data.lines}` : "Unknown size";
                
                document.getElementById("log-content").innerHTML = `
                    <div class="mb-2">
                        ${logTypeInfo}<small class="text-muted">${lineInfo}</small>
                    </div>
                    <div class="bg-dark text-light p-3" style="height: 500px; overflow-y: auto; font-family: monospace; font-size: 0.85em;">
                        <pre class="text-light mb-0">${data.content}</pre>
                    </div>`;
            } else {
                document.getElementById("log-content").innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading log:</strong> ${data.error}
                    </div>`;
            }
        })
        .catch(error => {
            console.error("Error loading log:", error);
            document.getElementById("log-content").innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error loading log:</strong> ${error.message}
                </div>`;
        });
}

function refreshLogContent() {
    if (currentLogFile) {
        // Save current scroll position
        const logContent = document.getElementById("log-content");
        const scrollContainer = logContent.querySelector(".bg-dark");
        const savedScrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
        
        // Reload the log content
        loadLogFile(currentLogFile);
        
        // Restore scroll position after content loads
        setTimeout(() => {
            const newScrollContainer = document.getElementById("log-content").querySelector(".bg-dark");
            if (newScrollContainer) {
                newScrollContainer.scrollTop = savedScrollTop;
            }
        }, 500);
    }
}

function scrollToBottom() {
    const scrollContainer = document.getElementById("log-content").querySelector(".bg-dark");
    if (scrollContainer) {
        scrollContainer.scrollTop = scrollContainer.scrollHeight;
    }
}

function downloadLog() {
    if (currentLogFile) {
        // Only allow downloads for actual files, not virtual system logs
        if (currentLogFile.startsWith("system/")) {
            alert("System logs are virtual aggregations and cannot be downloaded. Use the copy button or view the content directly.");
            return;
        }
        window.open(`/api/logs/${currentLogFile}/download`, "_blank");
    }
}

// Manual refresh only - no auto-refresh to avoid scroll interruption
// Users can click the refresh button when needed
</script>
{% endblock %}
